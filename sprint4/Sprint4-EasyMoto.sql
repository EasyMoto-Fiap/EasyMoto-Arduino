
--SPRINT 4 - DATABASE (EASYMOTO)

-- Habilita logs no console 
SET SERVEROUTPUT ON SIZE UNLIMITED

---LIMPEZA (DROPs em ordem)
BEGIN EXECUTE IMMEDIATE 'DROP TRIGGER trg_audit_moto';        EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE Auditoria_Moto';          EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE Vaga CASCADE CONSTRAINTS';         EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE Moto CASCADE CONSTRAINTS';         EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE Localizacao CASCADE CONSTRAINTS';  EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE Locacao CASCADE CONSTRAINTS';      EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE Patio CASCADE CONSTRAINTS';        EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE Operador CASCADE CONSTRAINTS';     EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE Funcionario CASCADE CONSTRAINTS';  EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE Filial CASCADE CONSTRAINTS';       EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE Cliente CASCADE CONSTRAINTS';      EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP TABLE Empresa CASCADE CONSTRAINTS';      EXCEPTION WHEN OTHERS THEN NULL; END;
/

------ Criação das Tabelas ------

-- EMPRESA
CREATE TABLE Empresa (
  id_empresa   NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nome_empresa VARCHAR2(50) NOT NULL,
  cnpj         VARCHAR2(14) NOT NULL UNIQUE
);

-- CLIENTE
CREATE TABLE Cliente (
  id_cliente       NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nome_cliente     VARCHAR2(100) NOT NULL,
  cpf_cliente      VARCHAR2(11)  NOT NULL UNIQUE,
  telefone_cliente VARCHAR2(15)  NOT NULL,
  email_cliente    VARCHAR2(100) NOT NULL
);

-- FILIAL
CREATE TABLE Filial (
  id_filial     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nome_filial   VARCHAR2(50) NOT NULL,
  cidade        VARCHAR2(50) NOT NULL,
  estado        VARCHAR2(2)  NOT NULL,
  pais          VARCHAR2(50) NOT NULL,
  endereco      VARCHAR2(100) NOT NULL,
  empresa_id    NUMBER NOT NULL,
  CONSTRAINT filial_empresa_fk FOREIGN KEY (empresa_id) REFERENCES Empresa(id_empresa)
);

-- FUNCIONARIO 
CREATE TABLE Funcionario (
  id_func        NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nome_func      VARCHAR2(100) NOT NULL,
  cpf_func       VARCHAR2(11)  NOT NULL UNIQUE,
  cargo          NUMBER(1)     NOT NULL,
  telefone_func  VARCHAR2(15)  NOT NULL,
  email_func     VARCHAR2(100) NOT NULL,
  filial_id      NUMBER        NOT NULL,
  CONSTRAINT funcionario_filial_fk FOREIGN KEY (filial_id) REFERENCES Filial(id_filial),
  CONSTRAINT funcionario_cargo_ck CHECK (cargo IN (1,2))
);
COMMENT ON COLUMN Funcionario.cargo IS '1=ADMIN; 2=USER';

-- OPERADOR 
CREATE TABLE Operador (
  id_operador   NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nome_opr      VARCHAR2(100) NOT NULL,
  cpf_opr       VARCHAR2(11)  NOT NULL UNIQUE,
  telefone_opr  VARCHAR2(14)  NOT NULL,
  email_opr     VARCHAR2(100) NOT NULL,
  filial_id     NUMBER        NOT NULL,
  CONSTRAINT operador_filial_fk FOREIGN KEY (filial_id) REFERENCES Filial(id_filial)
);

-- PATIO
CREATE TABLE Patio (
  id_patio      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  nome_patio    VARCHAR2(50),
  tamanho_patio VARCHAR2(50) NOT NULL,
  andar         VARCHAR2(1),
  filial_id     NUMBER NOT NULL,
  CONSTRAINT patio_filial_fk FOREIGN KEY (filial_id) REFERENCES Filial(id_filial)
);

-- LOCAÇÃO 
CREATE TABLE Locacao (
  id_locacao      NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  data_inicio     DATE       NOT NULL,
  data_fim        DATE       NOT NULL,
  status_locacao  NUMBER(1)  NOT NULL,
  cliente_id      NUMBER     NOT NULL,
  CONSTRAINT locacao_cliente_fk FOREIGN KEY (cliente_id) REFERENCES Cliente(id_cliente),
  CONSTRAINT locacao_status_ck CHECK (status_locacao IN (1,2,3)),
  CONSTRAINT locacao_datas_ck  CHECK (data_fim >= data_inicio)
);
COMMENT ON COLUMN Locacao.status_locacao IS '1=Aberta; 2=Finalizada; 3=Cancelada';

-- LOCALIZAÇÃO (status textual à parte – não faz parte do escopo de códigos)
CREATE TABLE Localizacao (
  id_localizacao  NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  status_loc      NUMBER(1)  NOT NULL,
  data_hora       TIMESTAMP DEFAULT SYSTIMESTAMP,
  zona_virtual    VARCHAR2(50),
  latitude        NUMBER(9,6),
  longitude       NUMBER(9,6)
);
COMMENT ON COLUMN Localizacao.status_loc IS '1=Zona A; 2=Zona B; 3=Zona C';



-- MOTO (status numérico 1/2/3)
CREATE TABLE Moto (
  id_moto         NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  placa           VARCHAR2(10) UNIQUE,
  modelo          VARCHAR2(50) NOT NULL,
  ano_fabricacao  NUMBER(4)    NOT NULL,
  status_moto     NUMBER(1)    NOT NULL,
  locacao_id      NUMBER       NOT NULL,
  localizacao_id  NUMBER       NOT NULL,
  CONSTRAINT moto_locacao_fk     FOREIGN KEY (locacao_id)     REFERENCES Locacao(id_locacao),
  CONSTRAINT moto_localizacao_fk FOREIGN KEY (localizacao_id) REFERENCES Localizacao(id_localizacao),
  CONSTRAINT moto_status_ck CHECK (status_moto IN (1,2,3))
);
COMMENT ON COLUMN Moto.status_moto IS '1=Ativa; 2=Em uso; 3=Manutenção';

-- VAGA 
CREATE TABLE Vaga (
  id_vaga     NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  status_vaga NUMBER(1)  NOT NULL,         
  patio_id    NUMBER     NOT NULL,
  moto_id     NUMBER     NULL,             
  fileira     VARCHAR2(1) NOT NULL,
  coluna      VARCHAR2(1) NOT NULL,

  CONSTRAINT vaga_patio_fk FOREIGN KEY (patio_id) REFERENCES Patio(id_patio),
  CONSTRAINT vaga_moto_fk FOREIGN KEY (moto_id) REFERENCES Moto(id_moto) ON DELETE SET NULL, -- libera a vaga se a moto for excluída
  CONSTRAINT vaga_moto_un UNIQUE (moto_id),
  CONSTRAINT vaga_status_ck CHECK (status_vaga IN (1,2,3))
);

COMMENT ON COLUMN Vaga.status_vaga IS '1=Livre; 2=Ocupada; 3=Indefinida';


--- INSERTS ---

-- EMPRESA
INSERT INTO Empresa (id_empresa, nome_empresa, cnpj) VALUES (1, 'Mottu Ltda',  '12345678000191');
INSERT INTO Empresa (id_empresa, nome_empresa, cnpj) VALUES (2, 'Alpha Motos', '23456789000191');
INSERT INTO Empresa (id_empresa, nome_empresa, cnpj) VALUES (3, 'Beta Motors',  '34567890000191');
INSERT INTO Empresa (id_empresa, nome_empresa, cnpj) VALUES (4, 'Gamma Riders', '45678900000191');
INSERT INTO Empresa (id_empresa, nome_empresa, cnpj) VALUES (5, 'Omega Bikes',  '56789000000191');

-- CLIENTE
INSERT INTO Cliente (id_cliente, nome_cliente, cpf_cliente, telefone_cliente, email_cliente)
VALUES (1,'João Silva','12345678901','11988880001','joao@email.com');
INSERT INTO Cliente (id_cliente, nome_cliente, cpf_cliente, telefone_cliente, email_cliente)
VALUES (2,'Maria Souza','23456789012','11988880002','maria@email.com');
INSERT INTO Cliente (id_cliente, nome_cliente, cpf_cliente, telefone_cliente, email_cliente)
VALUES (3,'Pedro Santos','34567890123','11988880003','pedro@email.com');
INSERT INTO Cliente (id_cliente, nome_cliente, cpf_cliente, telefone_cliente, email_cliente)
VALUES (4,'Ana Costa','45678901234','11988880004','ana@email.com');
INSERT INTO Cliente (id_cliente, nome_cliente, cpf_cliente, telefone_cliente, email_cliente)
VALUES (5,'Lucas Lima','56789012345','11988880005','lucas@email.com');

-- FILIAL
INSERT INTO Filial (id_filial, nome_filial, cidade, estado, pais, endereco, empresa_id)
VALUES (1,'Filial SP Centro','São Paulo','SP','Brasil','Rua A, 123',1);
INSERT INTO Filial (id_filial, nome_filial, cidade, estado, pais, endereco, empresa_id)
VALUES (2,'Filial RJ Zona Sul','Rio de Janeiro','RJ','Brasil','Av B, 456',1);
INSERT INTO Filial (id_filial, nome_filial, cidade, estado, pais, endereco, empresa_id)
VALUES (3,'Filial MX Norte','Monterrey','NL','México','Calle C, 789',2);
INSERT INTO Filial (id_filial, nome_filial, cidade, estado, pais, endereco, empresa_id)
VALUES (4,'Filial MX Sul','Cidade do México','CD','México','Calle D, 101',2);
INSERT INTO Filial (id_filial, nome_filial, cidade, estado, pais, endereco, empresa_id)
VALUES (5,'Filial BH','Belo Horizonte','MG','Brasil','Rua E, 202',1);

-- FUNCIONARIO 
INSERT INTO Funcionario (nome_func, cpf_func, cargo, telefone_func, email_func, filial_id)
VALUES ('Lucas Mendes',  '11223344556', 2, '11911112222', 'lucas.mendes@email.com', 1);
INSERT INTO Funcionario (nome_func, cpf_func, cargo, telefone_func, email_func, filial_id)
VALUES ('Bruna Costa',   '22334455667', 1, '11922223333', 'bruna.costa@email.com', 1);
INSERT INTO Funcionario (nome_func, cpf_func, cargo, telefone_func, email_func, filial_id)
VALUES ('Rafael Torres', '33445566778', 1, '11933334444', 'rafael.torres@email.com', 2);
INSERT INTO Funcionario (nome_func, cpf_func, cargo, telefone_func, email_func, filial_id)
VALUES ('Juliana Rocha', '44556677889', 2, '11944445555', 'juliana.rocha@email.com', 3);
INSERT INTO Funcionario (nome_func, cpf_func, cargo, telefone_func, email_func, filial_id)
VALUES ('Thiago Dias',   '55667788990', 1, '11955556666', 'thiago.dias@email.com', 3);

-- OPERADOR
INSERT INTO Operador (nome_opr, cpf_opr, telefone_opr, email_opr, filial_id)
VALUES ('Paulo Henrique','66778899001','11966667777','paulo.henrique@email.com',1);
INSERT INTO Operador (nome_opr, cpf_opr, telefone_opr, email_opr, filial_id)
VALUES ('Carla Nunes','77889900112','11977778888','carla.nunes@email.com',2);
INSERT INTO Operador (nome_opr, cpf_opr, telefone_opr, email_opr, filial_id)
VALUES ('Diego Matos','88990011223','11988889999','diego.matos@email.com',3);
INSERT INTO Operador (nome_opr, cpf_opr, telefone_opr, email_opr, filial_id)
VALUES ('Aline Moreira','99001122334','11999990000','aline.moreira@email.com',2);
INSERT INTO Operador (nome_opr, cpf_opr, telefone_opr, email_opr, filial_id)
VALUES ('Leandro Pires','10111213141','11910111213','leandro.pires@email.com',5);

-- PATIO
INSERT INTO Patio (id_patio, nome_patio, tamanho_patio, andar, filial_id)
VALUES (1,'Pátio 1','Grande','1',1);
INSERT INTO Patio (id_patio, nome_patio, tamanho_patio, andar, filial_id)
VALUES (2,'Pátio 2','Médio','2',2);
INSERT INTO Patio (id_patio, nome_patio, tamanho_patio, andar, filial_id)
VALUES (3,'Pátio 3','Pequeno','1',3);
INSERT INTO Patio (id_patio, nome_patio, tamanho_patio, andar, filial_id)
VALUES (4,'Pátio 4','Grande','3',4);
INSERT INTO Patio (id_patio, nome_patio, tamanho_patio, andar, filial_id)
VALUES (5,'Pátio 5','Médio','1',5);

-- LOCAÇÃO (1=Aberta; 2=Finalizada; 3=Cancelada)
INSERT INTO Locacao (id_locacao, data_inicio, data_fim, status_locacao, cliente_id)
VALUES (1, DATE '2025-05-01', DATE '2025-05-05', 1, 1);
INSERT INTO Locacao (id_locacao, data_inicio, data_fim, status_locacao, cliente_id)
VALUES (2, DATE '2025-05-02', DATE '2025-05-06', 1, 2);
INSERT INTO Locacao (id_locacao, data_inicio, data_fim, status_locacao, cliente_id)
VALUES (3, DATE '2025-05-03', DATE '2025-05-07', 2, 3);
INSERT INTO Locacao (id_locacao, data_inicio, data_fim, status_locacao, cliente_id)
VALUES (4, DATE '2025-05-04', DATE '2025-05-08', 3, 4);
INSERT INTO Locacao (id_locacao, data_inicio, data_fim, status_locacao, cliente_id)
VALUES (5, DATE '2025-05-05', DATE '2025-05-09', 1, 5);

-- LOCALIZAÇÃO
INSERT INTO Localizacao (id_localizacao, status_loc, data_hora, zona_virtual, latitude, longitude)
VALUES (1, 1, SYSTIMESTAMP, '1', -23.550520, -46.633308);
INSERT INTO Localizacao (id_localizacao, status_loc, data_hora, zona_virtual, latitude, longitude)
VALUES (2, 2,     SYSTIMESTAMP, '2', -22.906847, -43.172896);
INSERT INTO Localizacao (id_localizacao, status_loc, data_hora, zona_virtual, latitude, longitude)
VALUES (3, 2, SYSTIMESTAMP, '3',  19.432608, -99.133209);
INSERT INTO Localizacao (id_localizacao, status_loc, data_hora, zona_virtual, latitude, longitude)
VALUES (4, 3, SYSTIMESTAMP, '3', -19.815700, -43.954200);
INSERT INTO Localizacao (id_localizacao, status_loc, data_hora, zona_virtual, latitude, longitude)
VALUES (5, 1,     SYSTIMESTAMP, '2',  -3.717220, -38.543300);

-- MOTO (1=Ativa; 2=Em uso; 3=Manutenção)
INSERT INTO Moto (id_moto, placa, modelo, ano_fabricacao, status_moto, locacao_id, localizacao_id)
VALUES (1,'ABC1D23','Honda CG 160', 2022, 1, 1, 1);
INSERT INTO Moto (id_moto, placa, modelo, ano_fabricacao, status_moto, locacao_id, localizacao_id)
VALUES (2,'DEF4G56','Yamaha Factor', 2023, 2, 2, 2);
INSERT INTO Moto (id_moto, placa, modelo, ano_fabricacao, status_moto, locacao_id, localizacao_id)
VALUES (3,'GHI7J89','Shineray XY 50',2021, 3, 3, 3);
INSERT INTO Moto (id_moto, placa, modelo, ano_fabricacao, status_moto, locacao_id, localizacao_id)
VALUES (4,'JKL0M12','Honda Biz 110i',2024, 1, 4, 4);
INSERT INTO Moto (id_moto, placa, modelo, ano_fabricacao, status_moto, locacao_id, localizacao_id)
VALUES (5,'MNO3P45','Mottu Sport 110i',2025, 2, 5, 5);

-- VAGA (1=Livre; 2=Ocupada; 3=Indefinida)
INSERT INTO Vaga (id_vaga, status_vaga, patio_id, moto_id, fileira, coluna)
VALUES (1,2,1,1,'A','1');
INSERT INTO Vaga (id_vaga, status_vaga, patio_id, moto_id, fileira, coluna)
VALUES (2,2,2,2,'B','2');
INSERT INTO Vaga (id_vaga, status_vaga, patio_id, moto_id, fileira, coluna)
VALUES (3,1,3,3,'C','3');
INSERT INTO Vaga (id_vaga, status_vaga, patio_id, moto_id, fileira, coluna)
VALUES (4,2,4,4,'D','4');
INSERT INTO Vaga (id_vaga, status_vaga, patio_id, moto_id, fileira, coluna)
VALUES (5,1,5,5,'E','5');

UPDATE Vaga
   SET status_vaga = CASE WHEN moto_id IS NULL THEN 1 ELSE 2 END;

COMMIT;

------- AUDITORIA (tabela + trigger) -------

CREATE TABLE Auditoria_Moto (
  id_audit   NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  user_name  VARCHAR2(128),
  operacao   VARCHAR2(10),
  data_hora  TIMESTAMP DEFAULT SYSTIMESTAMP,
  old_values CLOB,
  new_values CLOB
);

CREATE OR REPLACE TRIGGER trg_audit_moto
AFTER INSERT OR UPDATE OR DELETE ON Moto
FOR EACH ROW
DECLARE
  v_user VARCHAR2(128) := SYS_CONTEXT('USERENV','SESSION_USER');
  v_old  CLOB;
  v_new  CLOB;
  FUNCTION esc(p_txt VARCHAR2) RETURN VARCHAR2 IS
  BEGIN
    RETURN REPLACE(NVL(p_txt,''), '"', '\"');
  END;
BEGIN
  IF INSERTING THEN
    v_new := '{'||
      '"id_moto":'||:NEW.id_moto||','||
      '"placa":"' ||esc(:NEW.placa)|| '",'||
      '"modelo":"' ||esc(:NEW.modelo)|| '",'||
      '"ano":'||:NEW.ano_fabricacao||','||
      '"status_moto":'||:NEW.status_moto||'}';

    INSERT INTO Auditoria_Moto(user_name, operacao, new_values)
    VALUES (v_user, 'INSERT', v_new);

  ELSIF UPDATING THEN
    v_old := '{'||
      '"id_moto":'||:OLD.id_moto||','||
      '"placa":"' ||esc(:OLD.placa)|| '",'||
      '"modelo":"' ||esc(:OLD.modelo)|| '",'||
      '"ano":'||:OLD.ano_fabricacao||','||
      '"status_moto":'||:OLD.status_moto||'}';

    v_new := '{'||
      '"id_moto":'||:NEW.id_moto||','||
      '"placa":"' ||esc(:NEW.placa)|| '",'||
      '"modelo":"' ||esc(:NEW.modelo)|| '",'||
      '"ano":'||:NEW.ano_fabricacao||','||
      '"status_moto":'||:NEW.status_moto||'}';

    INSERT INTO Auditoria_Moto(user_name, operacao, old_values, new_values)
    VALUES (v_user, 'UPDATE', v_old, v_new);

  ELSIF DELETING THEN
    v_old := '{'||
      '"id_moto":'||:OLD.id_moto||','||
      '"placa":"' ||esc(:OLD.placa)|| '",'||
      '"modelo":"' ||esc(:OLD.modelo)|| '",'||
      '"ano":'||:OLD.ano_fabricacao||','||
      '"status_moto":'||:OLD.status_moto||'}';

    INSERT INTO Auditoria_Moto(user_name, operacao, old_values)
    VALUES (v_user, 'DELETE', v_old);
  END IF;
END;
/
SHOW ERRORS

-- LIMPEZA extra (pacote)
BEGIN EXECUTE IMMEDIATE 'DROP PACKAGE BODY PKG_EASYMOTO'; EXCEPTION WHEN OTHERS THEN NULL; END;
/
BEGIN EXECUTE IMMEDIATE 'DROP PACKAGE PKG_EASYMOTO'; EXCEPTION WHEN OTHERS THEN NULL; END;
/

-- PACKAGE SPEC
CREATE OR REPLACE PACKAGE PKG_EASYMOTO AS
  TYPE t_cursor IS REF CURSOR;

  FUNCTION get_row_json(
    p_table_name IN VARCHAR2,
    p_pk_col     IN VARCHAR2,
    p_pk_value   IN VARCHAR2
  ) RETURN CLOB;

  FUNCTION dias_locacao(
    p_inicio IN DATE,
    p_fim    IN DATE
  ) RETURN NUMBER DETERMINISTIC;

  PROCEDURE motos_json(p_cliente_id IN Cliente.id_cliente%TYPE DEFAULT NULL);

  PROCEDURE resumo_locacao(p_out OUT t_cursor);
END PKG_EASYMOTO;
/
SHOW ERRORS

-- PACKAGE BODY
CREATE OR REPLACE PACKAGE BODY PKG_EASYMOTO AS

  -- utilitário de escape simples
  FUNCTION esc(p_txt VARCHAR2) RETURN VARCHAR2 IS
  BEGIN
    RETURN REPLACE(REPLACE(REPLACE(NVL(p_txt,''), '"','\"'), CHR(10), '\n'), CHR(13), '\r');
  END;

  FUNCTION get_row_json(
    p_table_name IN VARCHAR2,
    p_pk_col     IN VARCHAR2,
    p_pk_value   IN VARCHAR2
  ) RETURN CLOB
  IS
    TYPE t_col IS RECORD (name VARCHAR2(128), data_type VARCHAR2(128), is_num CHAR(1));
    TYPE t_cols IS TABLE OF t_col INDEX BY PLS_INTEGER;

    v_cols     t_cols;
    v_colcnt   PLS_INTEGER := 0;
    v_sql      CLOB;
    v_sel_list CLOB;

    v_cur    INTEGER := NULL;
    v_exec   INTEGER;
    v_piece  VARCHAR2(32767);
    v_json   CLOB := '{';
    v_first  BOOLEAN := TRUE;
    v_hasrow BOOLEAN := FALSE;
  BEGIN
    -- valida objeto e pk
    DECLARE v_cnt NUMBER; BEGIN
      SELECT COUNT(*) INTO v_cnt FROM USER_TAB_COLUMNS WHERE UPPER(table_name)=UPPER(p_table_name);
      IF v_cnt=0 THEN RAISE_APPLICATION_ERROR(-20051,'get_row_json: objeto não existe: '||p_table_name); END IF;

      SELECT COUNT(*) INTO v_cnt FROM USER_TAB_COLUMNS 
       WHERE UPPER(table_name)=UPPER(p_table_name) AND UPPER(column_name)=UPPER(p_pk_col);
      IF v_cnt=0 THEN RAISE_APPLICATION_ERROR(-20052,'get_row_json: pk não encontrada: '||p_pk_col); END IF;
    END;

    -- carrega colunas na ordem física
    FOR r IN (
      SELECT column_name, data_type, column_id
        FROM USER_TAB_COLUMNS
       WHERE UPPER(table_name)=UPPER(p_table_name)
       ORDER BY column_id
    ) LOOP
      v_colcnt := v_colcnt + 1;
      v_cols(v_colcnt).name      := r.column_name;
      v_cols(v_colcnt).data_type := r.data_type;
      v_cols(v_colcnt).is_num    := CASE WHEN r.data_type='NUMBER' THEN 'Y' ELSE 'N' END;
      v_sel_list := CASE
        WHEN v_sel_list IS NULL THEN
          CASE 
            WHEN r.data_type='DATE' THEN 'TO_CHAR('||r.column_name||',''YYYY-MM-DD"T"HH24:MI:SS'') "'||r.column_name||'"'
            WHEN r.data_type LIKE 'TIMESTAMP%' THEN 'TO_CHAR('||r.column_name||',''YYYY-MM-DD"T"HH24:MI:SS.FF3'') "'||r.column_name||'"'
            WHEN r.data_type='CLOB' THEN 'DBMS_LOB.SUBSTR('||r.column_name||',4000,1) "'||r.column_name||'"'
            ELSE r.column_name||' "'||r.column_name||'"'
          END
        ELSE
          v_sel_list || ', ' || CASE 
            WHEN r.data_type='DATE' THEN 'TO_CHAR('||r.column_name||',''YYYY-MM-DD"T"HH24:MI:SS'') "'||r.column_name||'"'
            WHEN r.data_type LIKE 'TIMESTAMP%' THEN 'TO_CHAR('||r.column_name||',''YYYY-MM-DD"T"HH24:MI:SS.FF3'') "'||r.column_name||'"'
            WHEN r.data_type='CLOB' THEN 'DBMS_LOB.SUBSTR('||r.column_name||',4000,1) "'||r.column_name||'"'
            ELSE r.column_name||' "'||r.column_name||'"'
          END
      END;
    END LOOP;

    v_sql := 'SELECT '||v_sel_list||
             '  FROM '||DBMS_ASSERT.SIMPLE_SQL_NAME(UPPER(p_table_name))||
             ' WHERE '||DBMS_ASSERT.SIMPLE_SQL_NAME(UPPER(p_pk_col))||' = :b1';

    v_cur := DBMS_SQL.open_cursor;
    DBMS_SQL.parse(v_cur, v_sql, DBMS_SQL.native);
    DBMS_SQL.bind_variable(v_cur, ':b1', p_pk_value);
    FOR i IN 1..v_colcnt LOOP DBMS_SQL.define_column(v_cur, i, v_piece, 32767); END LOOP;

    v_exec := DBMS_SQL.execute(v_cur);
    IF DBMS_SQL.fetch_rows(v_cur) > 0 THEN
      v_hasrow := TRUE;
      FOR i IN 1..v_colcnt LOOP
        DBMS_SQL.column_value(v_cur, i, v_piece);
        IF NOT v_first THEN v_json := v_json||','; ELSE v_first := FALSE; END IF;

        IF v_piece IS NULL THEN
          v_json := v_json||'"'||v_cols(i).name||'":null';
        ELSIF v_cols(i).is_num='Y' THEN
          v_json := v_json||'"'||v_cols(i).name||'":'||TRIM(v_piece);
        ELSE
          v_json := v_json||'"'||v_cols(i).name||'":"' || esc(v_piece) || '"';
        END IF;
      END LOOP;
    END IF;
    DBMS_SQL.close_cursor(v_cur);

    IF NOT v_hasrow THEN
      RAISE_APPLICATION_ERROR(-20053,'get_row_json: nenhuma linha em '||p_table_name||
        ' onde '||p_pk_col||'='||p_pk_value);
    END IF;

    RETURN v_json||'}';
  EXCEPTION
    WHEN OTHERS THEN
      IF v_cur IS NOT NULL AND DBMS_SQL.is_open(v_cur) THEN DBMS_SQL.close_cursor(v_cur); END IF;
      RAISE;
  END get_row_json;

  FUNCTION dias_locacao(p_inicio IN DATE, p_fim IN DATE) RETURN NUMBER DETERMINISTIC IS
  BEGIN
    IF p_inicio IS NULL OR p_fim IS NULL THEN
      RAISE_APPLICATION_ERROR(-20011,'Datas não podem ser nulas');
    END IF;
    IF p_fim < p_inicio THEN
      RAISE_APPLICATION_ERROR(-20012,'Data fim < início');
    END IF;
    RETURN p_fim - p_inicio;
  END dias_locacao;

  PROCEDURE motos_json(p_cliente_id IN Cliente.id_cliente%TYPE DEFAULT NULL) IS
    CURSOR c_moto IS
      SELECT m.id_moto, c.nome_cliente, l.status_locacao, loc.zona_virtual
        FROM Moto m
        JOIN Locacao l       ON l.id_locacao = m.locacao_id
        JOIN Cliente c       ON c.id_cliente = l.cliente_id
        JOIN Localizacao loc ON loc.id_localizacao = m.localizacao_id
       WHERE p_cliente_id IS NULL OR c.id_cliente = p_cliente_id
       ORDER BY m.id_moto;
    v_json  CLOB;
    v_count PLS_INTEGER := 0;
  BEGIN
    FOR r IN c_moto LOOP
      IF v_count = 0 THEN DBMS_OUTPUT.PUT_LINE('['); END IF;
      IF v_count > 0 THEN DBMS_OUTPUT.PUT_LINE(','); END IF;

      v_json := get_row_json('MOTO','ID_MOTO', TO_CHAR(r.id_moto));
      v_json := SUBSTR(v_json, 1, LENGTH(v_json)-1)
             || ',"cliente":"' || esc(r.nome_cliente) || '"'
             || ',"status_locacao":' || r.status_locacao
             || ',"zona":"' || esc(r.zona_virtual) || '"}';

      DBMS_OUTPUT.PUT_LINE(v_json);
      v_count := v_count + 1;
    END LOOP;
    IF v_count = 0 THEN DBMS_OUTPUT.PUT_LINE('[]'); ELSE DBMS_OUTPUT.PUT_LINE(']'); END IF;
  END motos_json;

  PROCEDURE resumo_locacao(p_out OUT t_cursor) IS
  BEGIN
    OPEN p_out FOR
      SELECT c.nome_cliente                                   AS cliente,
             l.status_locacao                                 AS status,
             SUM(PKG_EASYMOTO.dias_locacao(l.data_inicio, l.data_fim)) AS dias
        FROM Locacao l
        JOIN Cliente c ON c.id_cliente = l.cliente_id
       GROUP BY c.nome_cliente, l.status_locacao
       ORDER BY c.nome_cliente, l.status_locacao;
  END resumo_locacao;

END PKG_EASYMOTO;
/
SHOW ERRORS

----- TESTES (para prints no PDF)------
-- 1) Trigger de auditoria: INSERT / UPDATE / DELETE + conferência

-- limpeza idempotente da moto de teste (caso já exista)
DELETE FROM Moto WHERE UPPER(TRIM(placa)) = 'ZZZ9Z99';
COMMIT;

-- INSERT (gera auditoria INSERT)
INSERT INTO Moto (id_moto, placa, modelo, ano_fabricacao, status_moto, locacao_id, localizacao_id)
SELECT NVL(MAX(id_moto),0)+1, 'ZZZ9Z99', 'Teste Trigger', 2025, 1, 1, 1
  FROM Moto;
COMMIT;

-- UPDATE (gera auditoria UPDATE)
UPDATE Moto
   SET status_moto = 2
 WHERE UPPER(TRIM(placa)) = 'ZZZ9Z99';
COMMIT;

-- DELETE (gera auditoria DELETE)
DELETE FROM Moto
 WHERE UPPER(TRIM(placa)) = 'ZZZ9Z99';
COMMIT;

-- 2) Conferência da auditoria (últimos eventos)
SELECT id_audit, user_name, operacao,
       TO_CHAR(data_hora,'YYYY-MM-DD HH24:MI:SS') AS dt,
       DBMS_LOB.SUBSTR(old_values,4000) AS old_v,
       DBMS_LOB.SUBSTR(new_values,4000) AS new_v
  FROM Auditoria_Moto
 ORDER BY id_audit DESC
FETCH FIRST 6 ROWS ONLY;


-- Testes do pacote PKG_EASYMOTO
-- Teste 1: função get_row_json (retorna JSON)
BEGIN
  DBMS_OUTPUT.PUT_LINE('Teste 1 - get_row_json (MOTO ID=1)');
  DBMS_OUTPUT.PUT_LINE(DBMS_LOB.SUBSTR(
    PKG_EASYMOTO.get_row_json('MOTO','ID_MOTO','1'),
    4000, 1
  ));
END;
/
SHOW ERRORS

-- Teste 2: função dias_locacao (datas válidas)
BEGIN
  DBMS_OUTPUT.PUT_LINE('Teste 2 - dias_locacao (datas válidas)');
  DBMS_OUTPUT.PUT_LINE(PKG_EASYMOTO.dias_locacao(DATE '2025-05-01', DATE '2025-05-05'));
END;
/
SHOW ERRORS

-- Teste 2A: função dias_locacao (erro proposital)
BEGIN
  DBMS_OUTPUT.PUT_LINE('Teste 2A - dias_locacao (data fim < início)');
  DBMS_OUTPUT.PUT_LINE(PKG_EASYMOTO.dias_locacao(DATE '2025-05-10', DATE '2025-05-01'));
EXCEPTION
  WHEN OTHERS THEN
    DBMS_OUTPUT.PUT_LINE('Exceção capturada: '||SQLERRM);
END;
/
SHOW ERRORS

-- Teste 3: procedure motos_json (todos os clientes)
BEGIN
  DBMS_OUTPUT.PUT_LINE('Teste 3 - motos_json (todos os clientes)');
  PKG_EASYMOTO.motos_json(NULL);
END;
/
SHOW ERRORS

-- Teste 3A: procedure motos_json (cliente_id = 1)
BEGIN
  DBMS_OUTPUT.PUT_LINE('Teste 3A - motos_json (cliente_id = 1)');
  PKG_EASYMOTO.motos_json(1);
END;
/
SHOW ERRORS

-- Teste 3B: procedure motos_json (cliente inexistente)
BEGIN
  DBMS_OUTPUT.PUT_LINE('Teste 3B - motos_json (cliente inexistente = -1)');
  PKG_EASYMOTO.motos_json(-1);
END;
/
SHOW ERRORS

-- Teste 4: procedure resumo_locacao (cursor)
DECLARE
  cur     PKG_EASYMOTO.t_cursor;
  v_cli   VARCHAR2(100);
  v_st    NUMBER;
  v_dias  NUMBER;
BEGIN
  DBMS_OUTPUT.PUT_LINE('Teste 4 - resumo_locacao (cursor)');
  DBMS_OUTPUT.PUT_LINE('Cliente | Status | Dias');

  PKG_EASYMOTO.resumo_locacao(cur);

  LOOP
    FETCH cur INTO v_cli, v_st, v_dias;
    EXIT WHEN cur%NOTFOUND;
    DBMS_OUTPUT.PUT_LINE(v_cli||' | '||v_st||' | '||v_dias);
  END LOOP;
  CLOSE cur;

  DBMS_OUTPUT.PUT_LINE('Fim do resumo');
EXCEPTION
  WHEN OTHERS THEN
    DBMS_OUTPUT.PUT_LINE('Erro em Teste 4: '||SQLERRM);
END;
/
SHOW ERRORS

----- EXPORTAÇÃO DATASET JSON
BEGIN
  PKG_EASYMOTO.motos_json(NULL);
END;
/
